<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hệ thống Tra cứu Hợp đồng</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div class="max-w-4xl mx-auto py-12 px-4">
      <div class="bg-white rounded-xl shadow-sm p-8 border border-slate-200">
        <h1 class="text-2xl font-bold text-slate-800 mb-6 text-center">
          Tra cứu thông tin Hợp đồng
        </h1>

        <div class="flex gap-2 mb-8">
          <input
            id="searchInput"
            type="text"
            placeholder="Nhập Số HĐ, Tên khách hàng, Sản phẩm..."
            class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
            onkeypress="if(event.key === 'Enter') handleSearch()"
          />
          <button
            onclick="handleSearch()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
          >
            Tìm kiếm
          </button>
        </div>

        <div id="loading" class="hidden text-center py-4">
          <div
            class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-blue-600 rounded-full"
            role="status"
          ></div>
          <p class="text-slate-500 mt-2">Đang truy vấn dữ liệu...</p>
        </div>

        <div id="results" class="space-y-4"></div>
      </div>
    </div>

    <script>
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbukrHYV2wCa5Qto147Vww5E4_u-wXrNl_M24ZIRpOJ4bGbrrsxurui2MRlSuzxs9_EyEYB84qTudh/pub?gid=1482399048&single=true&output=csv";

      let allData = [];
      let headers = [];

      // Parse CSV thành array
      function parseCSV(csv) {
        const lines = csv.split('\n');
        const result = [];

        // Xử lý header
        headers = parseCSVLine(lines[0]);

        // Xử lý data
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim()) {
            const values = parseCSVLine(lines[i]);
            const obj = {};
            headers.forEach((header, index) => {
              obj[header] = values[index] || '';
            });
            result.push(obj);
          }
        }
        return result;
      }

      // Parse một dòng CSV (xử lý trường hợp có dấu phẩy trong ngoặc kép)
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }

      // Load dữ liệu khi trang được mở
      async function loadData() {
        try {
          const response = await fetch(CSV_URL);
          const csv = await response.text();
          allData = parseCSV(csv);
          console.log('Đã tải', allData.length, 'hợp đồng');
        } catch (error) {
          console.error('Lỗi tải dữ liệu:', error);
        }
      }

      // Tìm kiếm
      async function handleSearch() {
        const query = document.getElementById("searchInput").value.trim().toLowerCase();
        if (!query) return;

        const resultsDiv = document.getElementById("results");
        const loading = document.getElementById("loading");

        resultsDiv.innerHTML = "";
        loading.classList.remove("hidden");

        // Nếu chưa load data, load ngay
        if (allData.length === 0) {
          await loadData();
        }

        // Tìm kiếm
        const results = allData.filter(item => {
          return Object.values(item).some(value =>
            value.toString().toLowerCase().includes(query)
          );
        });

        loading.classList.add("hidden");

        if (results.length === 0) {
          resultsDiv.innerHTML = '<p class="text-center text-slate-500">Không tìm thấy dữ liệu phù hợp.</p>';
          return;
        }

        resultsDiv.innerHTML = `
          <p class="text-sm text-slate-500 mb-4">Tìm thấy ${results.length} kết quả</p>
          ${results.map(item => `
            <div class="p-4 border border-slate-200 rounded-lg bg-slate-50 hover:bg-white hover:shadow-md transition-all">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <div>
                  <span class="text-slate-500">Số Hợp đồng:</span>
                  <span class="font-bold text-blue-600 ml-1">${item['Số Hợp đồng'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Ngày:</span>
                  <span class="ml-1">${item['Ngày/tháng/năm'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Khách hàng:</span>
                  <span class="font-medium ml-1">${item['Khách hàng trên hợp đồng'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Lĩnh vực:</span>
                  <span class="ml-1">${item['Lãnh vực kinh doanh'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Sản phẩm:</span>
                  <span class="ml-1">${item['Sản phẩm đăng quảng cáo'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Loại hình QC:</span>
                  <span class="ml-1">${item['Loại hình quảng cáo'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Vị trí:</span>
                  <span class="ml-1">${item['Vị trí đăng'] || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-slate-500">Số kỳ:</span>
                  <span class="ml-1">${item['Số kỳ đang thực hiện / Tổng số kỳ trong hợp đồng'] || 'N/A'}</span>
                </div>
                <div class="md:col-span-2">
                  <span class="text-slate-500">Người thực hiện:</span>
                  <span class="ml-1">${item['Người thực hiện hợp đồng'] || 'N/A'}</span>
                </div>
              </div>
            </div>
          `).join('')}
        `;
      }

      // Load dữ liệu khi trang mở
      loadData();
    </script>
  </body>
</html>
